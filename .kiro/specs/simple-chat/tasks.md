# Implementation Tasks: simple-chat

## Overview
シンプルなチャットアプリケーションの実装タスク。Client-Server + Event-Driven (Pub/Sub)アーキテクチャを採用し、Socket.IOによるリアルタイム双方向通信を実現する。React + TypeScriptでフロントエンド、Express.js + TypeScriptでバックエンドを構築し、型安全性と保守性を重視する。

この実装は段階的なアプローチを採用し、プロジェクト基盤の構築、データ層の実装、サーバーサイドロジック、フロントエンドUI、統合テストの順で進める。

## Task List

### 1. バックエンドプロジェクト基盤構築 (P)
Node.js + Express.js + TypeScriptのバックエンド環境を構築し、Socket.IOサーバーを初期化する。

対応要件: 非機能要件（セキュリティ）

- [ ] **1.1 バックエンドプロジェクト初期化**
  - Node.js 20.x プロジェクトを作成し、TypeScript、Express.js、Socket.IO、express-validator、helmetの依存関係をインストールする
  - tsconfig.jsonを設定し、型安全なコンパイル環境を構築する
  - package.jsonにビルドスクリプトと開発用スクリプト（nodemon）を追加する
  - 推定時間: 1時間

- [ ] **1.2 Express.jsとSocket.IOサーバーの統合**
  - Express.jsアプリケーションを作成し、HTTPサーバーでラップする
  - Socket.IOサーバーをHTTPサーバーに統合し、WebSocket接続を有効化する
  - TypeScriptの型定義（ServerToClientEvents、ClientToServerEvents、SocketData）を定義する
  - CORS設定を追加し、開発環境でのクライアント接続を許可する
  - 推定時間: 2時間

- [ ] **1.3 セキュリティミドルウェアの設定**
  - helmetミドルウェアを設定し、CSP（Content Security Policy）を構成する
  - express-validatorをセットアップし、入力バリデーションのバリデーターチェーンを定義する
  - エラーハンドリングミドルウェアを実装し、統一されたエラーレスポンスを返す
  - 推定時間: 1.5時間

### 2. フロントエンドプロジェクト基盤構築 (P)
React + TypeScript + Viteのフロントエンド環境を構築し、Socket.IOクライアントを統合する。

対応要件: 非機能要件（ユーザビリティ、レスポンシブデザイン）

- [ ] **2.1 フロントエンドプロジェクト初期化**
  - Viteを使用してReact + TypeScriptプロジェクトを作成する
  - Socket.IO Clientライブラリをインストールする
  - 基本的なディレクトリ構造（src/components、src/hooks、src/types）を作成する
  - 推定時間: 1時間

- [ ] **2.2 TypeScript型定義の共有設定**
  - バックエンドと共通の型定義（Message、User、AuthResponse、MessageResponse、ErrorResponse）をsrc/types/index.tsに定義する
  - Socket.IOイベント型定義をクライアント側で再利用可能にする
  - 推定時間: 1時間

- [ ] **2.3 基本的なUIレイアウトとスタイリング**
  - レスポンシブデザインのための基本CSSまたはTailwind CSSをセットアップする
  - Appコンポーネントを作成し、ルーティング（ログイン画面 ↔ チャット画面）を実装する
  - 推定時間: 1.5時間

### 3. データ層の実装（In-Memoryストア） (P)
メッセージとユーザーを管理するIn-Memoryストアを実装する。

対応要件: 非機能要件（パフォーマンス）

- [ ] **3.1 UserStoreの実装**
  - UserStoreインターフェースを定義し、InMemoryUserStoreクラスを実装する
  - ユーザー追加（addUser）、削除（removeUser）、検索（getUserById、getUserByUsername）、全取得（getAllUsers）機能を実装する
  - ユーザー名の一意性チェックロジックを実装する
  - 推定時間: 2時間

- [ ] **3.2 MessageStoreの実装**
  - MessageStoreインターフェースを定義し、InMemoryMessageStoreクラスを実装する
  - メッセージ追加（addMessage）と履歴取得（getMessages）機能を実装し、UUID生成とタイムスタンプ付与を含める
  - 最新100件のみ保持する仕組みを実装（古いメッセージ自動削除）
  - 推定時間: 2時間

### 4. ユーザー認証機能の実装
ユーザー名ベースの認証機能を実装し、ログイン/ログアウト処理を提供する。

対応要件: 1, 5

- [ ] **4.1 AuthHandlerの実装**
  - AuthHandlerクラスを作成し、handleLogin、handleLogout、handleDisconnectメソッドを実装する
  - ユーザー名のバリデーション（1-20文字、英数字のみ）をexpress-validatorで実装する
  - ログイン成功時にUserStoreにユーザーを追加し、socket.dataにユーザー情報を保存する
  - ログアウト/切断時にUserStoreからユーザーを削除し、全クライアントに`users:updated`イベントをブロードキャストする
  - 推定時間: 3時間

- [ ] **4.2 認証イベントハンドラの統合**
  - Socket.IOサーバーに`auth:login`、`auth:logout`、`disconnect`イベントリスナーを登録する
  - 各イベントでAuthHandlerのメソッドを呼び出し、Acknowledgement callbackで結果を返す
  - エラーハンドリングを実装し、認証失敗時に適切なエラーレスポンスを返す
  - 推定時間: 1.5時間

### 5. メッセージング機能の実装
メッセージの送受信とブロードキャスト機能を実装する。

対応要件: 2, 3

- [ ] **5.1 MessageHandlerの実装**
  - MessageHandlerクラスを作成し、handleSendMessage、getMessageHistoryメソッドを実装する
  - メッセージテキストのバリデーション（1-500文字）とサニタイゼーション（HTMLタグ除去）を実装する
  - メッセージ送信時にMessageStoreに保存し、送信者名とタイムスタンプを付与する
  - 全接続中クライアントに`message:received`イベントでメッセージをブロードキャストする
  - 推定時間: 3時間

- [ ] **5.2 メッセージイベントハンドラの統合**
  - Socket.IOサーバーに`message:send`イベントリスナーを登録する
  - MessageHandlerのhandleSendMessageを呼び出し、Acknowledgementで送信結果を返す
  - 未認証ユーザーからのメッセージ送信を拒否し、AUTH_REQUIREDエラーを返す
  - 推定時間: 1.5時間

- [ ] **5.3 メッセージ履歴の提供**
  - 新規接続クライアントに対してメッセージ履歴（最新100件）を送信する機能を実装する
  - ログイン成功時にgetMessageHistoryを呼び出し、クライアントに履歴を送信する
  - 推定時間: 1時間

### 6. ユーザー一覧機能の実装
オンラインユーザー一覧のリアルタイム更新機能を実装する。

対応要件: 4

- [ ] **6.1 UserHandlerの実装**
  - UserHandlerクラスを作成し、getOnlineUsers、notifyUserJoined、notifyUserLeftメソッドを実装する
  - ユーザー追加/削除時に全クライアントに`users:updated`イベントをブロードキャストする
  - 推定時間: 2時間

- [ ] **6.2 ユーザー一覧更新の統合**
  - AuthHandlerのログイン/ログアウト/切断処理にUserHandlerの通知メソッドを統合する
  - 新規ログイン時とログアウト時に最新のユーザー一覧を全クライアントに送信する
  - 推定時間: 1時間

### 7. Reactフロントエンドの実装
ユーザーインターフェースを実装し、Socket.IOクライアントと統合する。

対応要件: 1, 2, 3, 4, 5, 非機能要件（ユーザビリティ、可用性）

- [ ] **7.1 useSocketカスタムフックの実装**
  - Socket.IO Clientを統合し、接続管理、イベント送受信、状態管理を行うuseSocketフックを作成する
  - login、logout、sendMessageメソッドを実装し、Acknowledgementで結果を処理する
  - `message:received`、`users:updated`、`error`イベントリスナーを登録し、ローカル状態を更新する
  - 接続状態（isConnected）、エラー状態（error）、メッセージ一覧（messages）、ユーザー一覧（users）を管理する
  - 自動再接続機能を有効化し、再接続時にメッセージ履歴を再取得する
  - 推定時間: 3時間

- [ ] **7.2 LoginPageコンポーネントの実装**
  - ユーザー名入力フォームを作成し、バリデーション（1-20文字、空チェック）を実装する
  - ログインボタンクリック時にuseSocket.loginを呼び出し、成功時にチャット画面に遷移する
  - エラーメッセージを表示し、送信中状態でボタンを無効化する
  - 推定時間: 2時間

- [ ] **7.3 MessageListコンポーネントの実装**
  - メッセージ一覧を時系列順に表示し、送信者名、本文、送信時刻をフォーマットして表示する
  - 自分のメッセージと他人のメッセージを視覚的に区別する（スタイリング）
  - 新着メッセージ時に自動スクロール機能を実装する
  - 推定時間: 2.5時間

- [ ] **7.4 MessageInputコンポーネントの実装**
  - メッセージ入力フォームを作成し、送信ボタンとEnterキー押下で送信する機能を実装する
  - メッセージ送信時にuseSocket.sendMessageを呼び出し、成功時に入力をクリアする
  - 送信中状態を表示し、空メッセージの送信を防ぐバリデーションを実装する
  - 推定時間: 2時間

- [ ] **7.5 UserListコンポーネントの実装**
  - オンラインユーザー一覧を表示し、現在のユーザーを強調表示する
  - ユーザー数カウントを表示する
  - 推定時間: 1.5時間

- [ ] **7.6 ChatPageコンポーネントの実装**
  - MessageList、MessageInput、UserListを統合し、チャット画面のレイアウトを構築する
  - ログアウトボタンを追加し、クリック時にuseSocket.logoutを呼び出してログイン画面に遷移する
  - レスポンシブデザインを適用し、モバイル端末でも利用可能にする
  - 推定時間: 2.5時間

- [ ] **7.7 エラーハンドリングとローディング状態の実装**
  - Error Boundaryを実装し、予期しないエラーをキャッチしてフォールバックUIを表示する
  - 接続切断時に「Reconnecting...」メッセージを表示し、再接続失敗時にエラーメッセージを表示する
  - ローディングスピナーを実装し、送信中やログイン中の状態を視覚的にフィードバックする
  - 推定時間: 2時間

### 8. ユニットテストの実装
個別コンポーネントとモジュールの単体テストを実装する。

対応要件: All

- [ ] **8.1 バックエンドストアのユニットテスト**
  - UserStoreのテスト: ユーザー追加、削除、検索、重複チェックをテストする
  - MessageStoreのテスト: メッセージ追加、履歴取得、100件制限をテストする
  - Jestを使用してテストを実装し、カバレッジ80%以上を目標とする
  - 推定時間: 2.5時間

- [ ] **8.2 バックエンドハンドラのユニットテスト**
  - AuthHandlerのテスト: ログイン、ログアウト、バリデーションエラーをSocket.IOモックでテストする
  - MessageHandlerのテスト: メッセージ送信、サニタイゼーション、ブロードキャストをモックでテストする
  - UserHandlerのテスト: ユーザー一覧取得、通知処理をテストする
  - 推定時間: 3時間

- [ ] **8.3 フロントエンドコンポーネントのユニットテスト**
  - useSocketフックのテスト: イベント送受信、状態更新をReact Hooks Testing Libraryでテストする
  - LoginPage、MessageInput、MessageList、UserListのテスト: ユーザー入力、状態更新、エラー表示をReact Testing Libraryでテストする
  - 推定時間: 3時間

### 9. 統合テストとE2Eテストの実装
コンポーネント間の連携とエンドツーエンドシナリオをテストする。

対応要件: All

- [ ] **9.1 Socket.IO統合テスト**
  - Socket.IO ClientとServer間のイベント送受信をテストする
  - 認証フロー、メッセージ送受信、ユーザー一覧更新のシナリオをテストする
  - 複数クライアント接続をシミュレートし、ブロードキャスト機能をテストする
  - 推定時間: 3時間

- [ ] **9.2 E2Eテスト（Playwright/Cypress）**
  - ログインフローのE2Eテスト: ユーザー名入力 → ログイン → チャット画面表示
  - メッセージ送受信のE2Eテスト: メッセージ送信 → 他クライアントに表示（複数ブラウザ）
  - ユーザー一覧更新のE2Eテスト: ログイン/ログアウト → 一覧リアルタイム更新
  - エラーハンドリングのE2Eテスト: 無効な入力 → エラーメッセージ表示
  - 推定時間: 4時間

- [ ]* **9.3 パフォーマンステスト**
  - 10同時接続の負荷テストをArtilleryまたはk6で実行し、メッセージ配信時間を測定する（1秒以内）
  - メモリ使用量とCPU使用率を監視し、長時間稼働時の安定性を検証する
  - 推定時間: 2時間

- [ ]* **9.4 セキュリティテスト**
  - XSS攻撃シミュレーションをOWASP ZAPで実行し、入力サニタイゼーションの有効性を検証する
  - CSP設定を検証し、外部スクリプト実行が防止されることを確認する
  - npm auditで依存ライブラリの脆弱性をチェックする
  - 推定時間: 2時間

### 10. デプロイメント準備
本番環境へのデプロイに必要な設定とドキュメントを整備する。

対応要件: 非機能要件（セキュリティ、可用性）

- [ ] **10.1 環境変数と設定管理**
  - .envファイルのテンプレートを作成し、PORT、NODE_ENV、CORS_ORIGIN、Socket.IO設定を定義する
  - 開発環境、ステージング環境、本番環境の設定を分離する
  - 推定時間: 1時間

- [ ] **10.2 ビルドとデプロイスクリプト**
  - バックエンドのTypeScriptビルドスクリプト（tsc）を設定する
  - フロントエンドのViteビルドスクリプト（vite build）を設定する
  - PM2設定ファイル（ecosystem.config.js）を作成し、本番サーバー起動設定を定義する
  - 推定時間: 1.5時間

- [ ] **10.3 Nginx設定とHTTPS/WSS対応**
  - Nginxリバースプロキシ設定を作成し、HTTPSとWebSocket Secure（WSS）を有効化する
  - 静的ファイル配信とSocket.IOエンドポイントのプロキシ設定を実装する
  - 推定時間: 2時間

- [ ]* **10.4 READMEとデプロイドキュメント**
  - プロジェクトのREADME.mdを作成し、セットアップ手順、開発方法、テスト実行方法を記載する
  - デプロイ手順書を作成し、環境構築、依存関係インストール、ビルド、起動、ヘルスチェックの手順を記載する
  - 推定時間: 2時間

---

## Notes

- **(P) マーカー**: 並行開発可能なタスク（タスク1, 2, 3は独立して開発可能）
- **推定時間**: 各サブタスクは1-3時間を想定（経験豊富な開発者基準）
- **統合**: 全てのタスクは既存システムと統合され、孤立した実装を避ける
- **要件カバレッジ**: 全要件（1-5および非機能要件）が少なくとも1つのタスクにマップされている
- **`- [ ]*` マーカー**: MVP後に延期可能なオプショナルタスク（パフォーマンステスト、セキュリティテスト、READMEなど）

---

*生成日時: 2026-02-02T00:00:00Z*
